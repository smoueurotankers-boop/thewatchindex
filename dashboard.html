<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CTTGC1SX5S"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CTTGC1SX5S');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Dashboard – The Watch Index</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="brand">Watch Index</div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="submit.html">Submit</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="privacy.html">Privacy</a></li>
    </ul>
  </nav>

  <div class="section">
    <h2>Current Watch Index</h2>
    <div id="lastUpdated" style="font-size:0.8rem; color:#888;"></div>
    <div id="refreshStatus" style="font-size:0.75rem; color:#4ade80; margin-top:0.25rem; min-height:1rem;"></div>
    <button id="refreshBtn" onclick="refreshData()" style="margin-bottom: 1rem; padding: 0.5rem 1rem; background-color: #d21313; color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">Refresh Data</button>
    <div class="cards" id="cards"></div>
    <canvas id="shipChart" style="max-width: 100%; margin-top:2rem;"></canvas>
    <canvas id="regionChart" style="max-width: 100%; margin-top:2rem;"></canvas>
  </div>

  <footer class="footer">© 2025 The Watch Index</footer>

  <script>
    let shipChart = null;
    let regionChart = null;

    async function loadData() {
      try {
        const cacheKey = Math.random().toString(36).substring(7);
        const res = await fetch('data/data.json?v=' + cacheKey);
        const data = await res.json();
        renderMetrics(data);
      } catch (err) {
        console.error('Failed to load data:', err);
        showRefreshStatus('Failed to load data', false);
      }
    }

    async function refreshData() {
      const btn = document.getElementById('refreshBtn');
      const statusDiv = document.getElementById('refreshStatus');
      
      // Disable button and show loading state
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.textContent = 'Refreshing...';
      statusDiv.textContent = 'Fetching latest data...';
      statusDiv.style.color = '#888';
      
      try {
        await loadData();
        // Show success message
        showRefreshStatus('✓ Data refreshed successfully', true);
      } catch (err) {
        showRefreshStatus('✗ Refresh failed', false);
      } finally {
        // Re-enable button
        setTimeout(() => {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
          btn.textContent = 'Refresh Data';
        }, 500);
      }
    }

    function showRefreshStatus(message, success) {
      const statusDiv = document.getElementById('refreshStatus');
      statusDiv.textContent = message;
      statusDiv.style.color = success ? '#4ade80' : '#f87171';
      
      // Clear message after 3 seconds
      setTimeout(() => {
        statusDiv.textContent = '';
      }, 3000);
    }

    // Auto-refresh data every 30 seconds
    setInterval(loadData, 30000);

    function renderMetrics(data) {
      const cards = document.getElementById('cards');
      const lastUpdated = document.getElementById('lastUpdated');
      cards.innerHTML = '';
      lastUpdated.textContent = data.updatedAt ? 'Last updated: ' + new Date(data.updatedAt).toLocaleString() : '';
      const metrics = [
        { title: 'Submissions', value: data.totals.submissions },
        { title: 'Avg sleep (24h)', value: data.averages.sleepHours.toFixed(1) + ' h' },
        { title: 'Avg rest breaches (7d)', value: data.averages.restViolations.toFixed(2) },
      ];
      metrics.forEach(m => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="card-title">${m.title}</div><div class="card-value">${m.value}</div>`;
        cards.appendChild(card);
      });
      
      // Destroy existing charts before creating new ones
      if (shipChart) {
        shipChart.destroy();
      }
      if (regionChart) {
        regionChart.destroy();
      }

      // Bar chart by ship type
      const shipCtx = document.getElementById('shipChart').getContext('2d');
      shipChart = new Chart(shipCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(data.byShip),
          datasets: [
            {
              label: '# Reports by Ship Type',
              data: Object.values(data.byShip),
              backgroundColor: '#d21313',
            },
          ],
        },
        options: {
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255,255,255,0.1)' },
            },
            y: {
              ticks: { color: '#e5e7eb', beginAtZero: true },
              grid: { color: 'rgba(255,255,255,0.1)' },
            },
          },
        },
      });
      // Bar chart by region
      const regionCtx = document.getElementById('regionChart').getContext('2d');
      regionChart = new Chart(regionCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(data.byRegion),
          datasets: [
            {
              label: '# Reports by Region',
              data: Object.values(data.byRegion),
              backgroundColor: '#d21313',
            },
          ],
        },
        options: {
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255,255,255,0.1)' },
            },
            y: {
              ticks: { color: '#e5e7eb', beginAtZero: true },
              grid: { color: 'rgba(255,255,255,0.1)' },
            },
          },
        },
      });
    }

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
